-- This query detects potential exploitation attempts by the following filters:
-- rundll32.exe execution with a command line potentially related to exploitation of the CVE
-- Remote server either:
-- 1: Is rarely accessed from organization machines
-- 2: Has a parent domain that is a common cloud hosting provider- may host an attacker controlled server

with query as (
    select split_part(split_part(lower(TARGET_PROCESS_COMMANDLINE), '//', 2), '/', 1) TARGET_SERVER,
           count(distinct AGENT_ID)                                                   DISTINCT_AIDS,
           count(distinct lower(TARGET_PROCESS_COMMANDLINE))                          DISTINCT_CMDLINES,
           any_value(TARGET_PROCESS_COMMANDLINE)                                      EXAMPLE_TARGET_PROCESS_COMMANDLINE,
           any_value(lower(split_part(TARGET_SERVER, '.', '-2') || '.' ||
                           split_part(TARGET_SERVER, '.', '-1')))                     PARENT_DOMAIN
    from INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
    where lower(TARGET_PROCESS_COMMANDLINE) like '%rundll32.exe _:\\windows\\system32\\davclnt.dll,%davsetcookie %'
      and EVENT_TIME > current_timestamp - interval '30d'
      and DEVICE_PLATFORM = 'WINDOWS'
      and TARGET_SERVER like '%.%'                                                     -- Either FQDN or IP
      and (INITIATING_PROCESS_NAME = 'svchost.exe' or INITIATING_PROCESS_NAME is null) -- Initiated by svchost
      --Filter out internal IP ranges
      and NOT (TARGET_SERVER LIKE '10.%'
        OR TARGET_SERVER LIKE '192.168.%'
        OR TARGET_SERVER LIKE '127.%'
        OR TARGET_SERVER REGEXP '^172\\.(1[6-9]|2[0-9]|3[0-1])\\..*' -- 172.16.0.0–172.31.255.255
        OR TARGET_SERVER LIKE '169.254.%'
        OR TARGET_SERVER LIKE '0.%'
        OR TARGET_SERVER REGEXP
           '^100\\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\\..*' -- 100.64.0.0–100.127.255.255
        OR TARGET_SERVER LIKE '192.0.0.%'
        OR TARGET_SERVER LIKE '192.0.2.%'
        OR TARGET_SERVER LIKE '192.88.99.%'
        OR TARGET_SERVER REGEXP '^198.1[8-9]\\..*'
        OR TARGET_SERVER LIKE '198.51.100.%'
        OR TARGET_SERVER LIKE '203.0.113.%'
        OR TARGET_SERVER LIKE '233.252.0.%'
        OR TARGET_SERVER REGEXP '^(22[4-9]|23[0-9])\\..*'
        OR TARGET_SERVER REGEXP '^(24[0-9]|25[0-5])\\..*'
        OR TARGET_SERVER like 'fc00%'
        OR TARGET_SERVER like 'fe80%'
        OR TARGET_SERVER like 'ff00%'
        or lower(TARGET_SERVER) like 'localhost:%'
        or lower(TARGET_SERVER) = 'localhost')
      and AGENT_ID in (
        select distinct agent_id
        from INVESTIGATION.EDR_PROCESS_CREATION_EVENTS
        where lower(TARGET_PROCESS_NAME) = 'outlook.exe'
          and event_time > current_timestamp - interval '30d'
          and device_platform = 'WINDOWS')
      and not lower(TARGET_SERVER) in (
        select DISTINCT lower(LAST_HOSTNAME)
        from INVESTIGATION.EDR_AGENT_INFO
        where LAST_SEEN > current_timestamp - interval '30d'
    )
    group by split_part(split_part(lower(TARGET_PROCESS_COMMANDLINE), '//', 2), '/', 1)),
     domain_ip_reputation as (
         select lower(DOMAIN) SERVER,
                FIRST_SEEN,
                LAST_SEEN,
                AGENT_IDS,
                AGENT_ID_COUNT,
                SPECIFIC_SOURCE_TYPE,
                'domain'      KIND
         from INVESTIGATION.EDR_DOMAIN_ORGANIZATIONAL_STATISTICS
         where last_seen > current_timestamp - interval '30d'
         union
         select REMOTE_IP server, first_seen, last_seen, agent_ids, agent_id_count, specific_source_type, 'ip' kind
         from INVESTIGATION.EDR_IP_ORGANIZATIONAL_STATISTICS
         where last_seen > current_timestamp - interval '30d'
         union
         --Parent Domain Extraction
         select lower(split_part(DOMAIN, '.', '-2') || '.' || split_part(DOMAIN, '.', '-1')) server,
                min(FIRST_SEEN)                                                              first_seen,
                max(LAST_SEEN)                                                               last_seen,
                any_value(AGENT_IDS)                                                         agent_ids,
                max(AGENT_ID_COUNT)                                                          agent_id_count,
                any_value(SPECIFIC_SOURCE_TYPE)                                              specific_source_type,
                'domain'                                                                     kind
         from INVESTIGATION.EDR_DOMAIN_ORGANIZATIONAL_STATISTICS
         where last_seen > current_timestamp - interval '30d'
         group by SERVER
     )
select TARGET_SERVER,
     query.DISTINCT_AIDS                                       NUMBER_OF_AGENT_IDS,
     DISTINCT_CMDLINES                                         NUMBER_OF_UNIQUE_COMMAND_LINES,
     EXAMPLE_TARGET_PROCESS_COMMANDLINE,
     iff(KIND = 'domain', PARENT_DOMAIN, null)                 PARENT_DOMAIN,
     FIRST_SEEN,
     LAST_SEEN,
     AGENT_IDS
from query
         left join domain_ip_reputation
                   on (TARGET_SERVER = SERVER or (PARENT_DOMAIN = SERVER and KIND = 'domain' and
                                                  not TARGET_SERVER regexp '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}'))
    qualify ROW_NUMBER() OVER (PARTITION BY TARGET_SERVER
        ORDER BY AGENT_ID_COUNT DESC) = 1 and
            (AGENT_ID_COUNT < 100 or TARGET_SERVER like any
                                     ('%.googleapis.com',
                                      '%.googlecode.com',
                                      '%.withyoutube.com',
                                      '%.withgoogle.com',
                                      '%.gateway.dev',
                                      '%.goog',
                                      '%.blogspot.%',
                                      '%.0emm.com',
                                      '%.run.app',
                                      '%.web.app',
                                      '%.pagespeedmobilizer.com',
                                      '%.publishproxy.com',
                                      '%.azure%.net',
                                      '%.azurecontainer.io',
                                      '%.cloudapp.net',
                                      '%.amazonaws.com%',
                                      '%.cloudfront.net',
                                      '%.elasticbeanstalk.com'))
order by NUMBER_OF_AGENT_IDS asc, NUMBER_OF_UNIQUE_COMMAND_LINES asc;
